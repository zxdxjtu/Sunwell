<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>ç‚‰çŸ³ä¼ è¯´è‡ªå®šä¹‰å¡ç‰Œç”Ÿæˆå™¨ - ä¿®å¤ç‰ˆ</title>
    <link rel="stylesheet" href="./assets/ç»å…¸éš¶å˜ç®€.css">
    <script src="./dist/sunwell.browser.js"></script>
    <style>
        /* ç»å…¸éš¶å˜ç®€ä½“å­—ä½“é…ç½® */
        @font-face {
            font-family: 'ç»å…¸éš¶å˜ç®€';
            src: url('./assets/ç»å…¸éš¶å˜ç®€.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #1e3c72 100%);
            min-height: 100vh;
            color: #fff;
            overflow-x: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 30px;
            align-items: start;
        }

        .form-section {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .preview-section {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: sticky;
            top: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #ffd700;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #ffd700;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .form-row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
        }

        .image-upload {
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .image-upload:hover {
            border-color: #ffd700;
            background: rgba(255, 215, 0, 0.1);
        }

        .image-upload input[type="file"] {
            position: absolute;
            left: -9999px;
        }

        .image-preview {
            max-width: 100%;
            max-height: 200px;
            border-radius: 8px;
            margin-top: 10px;
        }

        .btn {
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            color: #1e3c72;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.4);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .card-preview {
            text-align: center;
        }

        .card-preview h3 {
            margin-bottom: 15px;
            color: #ffd700;
        }

        .card-canvas {
            border: 3px solid #ffd700;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            background: #ffffff !important; /* å¼ºåˆ¶ç™½è‰²èƒŒæ™¯æå‡å¡ç‰Œæ˜¾ç¤ºæ•ˆæœ */
            background-color: #ffffff !important;
        }

        .status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            font-size: 14px;
        }

        .status.loading {
            background: rgba(76, 175, 80, 0.2);
            color: #4caf50;
        }

        .status.error {
            background: rgba(244, 67, 54, 0.2);
            color: #f44336;
        }

        .status.success {
            background: rgba(76, 175, 80, 0.2);
            color: #4caf50;
        }

        .preset-templates {
            margin-bottom: 20px;
        }

        .template-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .template-btn {
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 6px;
            color: #fff;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 12px;
        }

        .template-btn:hover {
            background: rgba(255, 215, 0, 0.2);
            border-color: #ffd700;
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .preview-section {
                position: static;
            }
        }

        @media (max-width: 768px) {
            .form-row,
            .form-row-3 {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .button-group {
                flex-direction: column;
            }
        }

        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: rgba(0, 0, 0, 0.8);
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”¥ ç‚‰çŸ³ä¼ è¯´è‡ªå®šä¹‰å¡ç‰Œç”Ÿæˆå™¨ ğŸ”¥</h1>
            <p>åˆ›å»ºå±äºä½ çš„ç‹¬ç‰¹ç‚‰çŸ³ä¼ è¯´å¡ç‰Œ - ä¿®å¤ç‰ˆæœ¬</p>
        </div>

        <div class="main-content">
            <div class="form-section">
                <div class="preset-templates">
                    <label>ğŸ“‹ é¢„è®¾æ¨¡æ¿</label>
                    <div class="template-grid">
                        <button class="template-btn" onclick="loadTemplate('legendary')">ä¼ è¯´éšä»</button>
                        <button class="template-btn" onclick="loadTemplate('epic')">å²è¯—éšä»</button>
                        <button class="template-btn" onclick="loadTemplate('rare')">ç¨€æœ‰éšä»</button>
                        <button class="template-btn" onclick="loadTemplate('random')">éšæœºç”Ÿæˆ</button>
                    </div>
                </div>

                <form id="cardForm">
                    <div class="form-group">
                        <label for="cardName">ğŸ·ï¸ å¡ç‰Œåç§°</label>
                        <input type="text" id="cardName" name="cardName" placeholder="è¾“å…¥å¡ç‰Œåç§°" maxlength="30">
                    </div>

                    <div class="form-group">
                        <label for="cardText">ğŸ“ å¡ç‰Œæè¿°</label>
                        <textarea id="cardText" name="cardText" placeholder="è¾“å…¥å¡ç‰Œæ•ˆæœæè¿°" maxlength="200"></textarea>
                    </div>

                    <div class="form-row-3">
                        <div class="form-group">
                            <label for="cost">ğŸ’ è´¹ç”¨</label>
                            <input type="number" id="cost" name="cost" min="0" max="20" value="1">
                        </div>
                        <div class="form-group">
                            <label for="attack">âš”ï¸ æ”»å‡»åŠ›</label>
                            <input type="number" id="attack" name="attack" min="0" max="30" value="1">
                        </div>
                        <div class="form-group">
                            <label for="health">â¤ï¸ ç”Ÿå‘½å€¼</label>
                            <input type="number" id="health" name="health" min="1" max="30" value="1">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="cardClass">ğŸ­ èŒä¸š</label>
                            <select id="cardClass" name="cardClass">
                                <option value="NEUTRAL">ä¸­ç«‹</option>
                                <option value="DRUID">å¾·é²ä¼Š</option>
                                <option value="HUNTER">çŒäºº</option>
                                <option value="MAGE">æ³•å¸ˆ</option>
                                <option value="PALADIN">åœ£éª‘å£«</option>
                                <option value="PRIEST">ç‰§å¸ˆ</option>
                                <option value="ROGUE">æ½œè¡Œè€…</option>
                                <option value="SHAMAN">è¨æ»¡ç¥­å¸</option>
                                <option value="WARLOCK">æœ¯å£«</option>
                                <option value="WARRIOR">æˆ˜å£«</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="rarity">ğŸ’ ç¨€æœ‰åº¦</label>
                            <select id="rarity" name="rarity">
                                <option value="COMMON">æ™®é€š</option>
                                <option value="RARE">ç¨€æœ‰</option>
                                <option value="EPIC">å²è¯—</option>
                                <option value="LEGENDARY">ä¼ è¯´</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="cardType">ğŸƒ å¡ç‰Œç±»å‹</label>
                            <select id="cardType" name="cardType">
                                <option value="MINION">éšä»</option>
                                <option value="SPELL">æ³•æœ¯</option>
                                <option value="WEAPON">æ­¦å™¨</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="race">ğŸ‰ ç§æ—</label>
                            <select id="race" name="race">
                                <option value="">æ— </option>
                                <option value="BEAST">é‡å…½</option>
                                <option value="DEMON">æ¶é­”</option>
                                <option value="DRAGON">é¾™</option>
                                <option value="ELEMENTAL">å…ƒç´ </option>
                                <option value="MECH">æœºæ¢°</option>
                                <option value="MURLOC">é±¼äºº</option>
                                <option value="PIRATE">æµ·ç›—</option>
                                <option value="TOTEM">å›¾è…¾</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="cardSet">ğŸ“¦ å¡ç‰Œç³»åˆ—</label>
                        <select id="cardSet" name="cardSet">
                            <option value="EXPERT1">ç»å…¸</option>
                            <option value="NAXX">çº³å…‹è¨ç›æ–¯</option>
                            <option value="GVG">åœ°ç²¾å¤§æˆ˜ä¾å„’</option>
                            <option value="BRM">é»‘çŸ³å±±çš„ç«ç„°</option>
                            <option value="TGT">å† å†›çš„è¯•ç‚¼</option>
                            <option value="LOE">æ¢é™©è€…åä¼š</option>
                            <option value="OG">ä¸Šå¤ä¹‹ç¥çš„ä½è¯­</option>
                            <option value="KARA">å¡æ‹‰èµä¹‹å¤œ</option>
                            <option value="GANGS">é¾™äº‰è™æ–—åŠ åŸºæ£®</option>
                            <option value="UNGORO">å‹‡é—¯å®‰æˆˆæ´›</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="artUpload">ğŸ¨ å¡ç‰Œè‰ºæœ¯å›¾</label>
                        <div class="image-upload" onclick="document.getElementById('artUpload').click()">
                            <input type="file" id="artUpload" accept="image/*" onchange="handleImageUpload(event)">
                            <div id="uploadText">
                                <p>ğŸ“¸ ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡</p>
                                <p style="font-size: 12px; opacity: 0.7;">æ”¯æŒ JPG, PNG, GIF æ ¼å¼</p>
                            </div>
                            <img id="imagePreview" class="image-preview" style="display: none;">
                        </div>
                    </div>

                    <div class="button-group">
                        <button type="button" class="btn" onclick="generateCard()">ğŸ¯ ç”Ÿæˆå¡ç‰Œ</button>
                        <button type="button" class="btn btn-secondary" onclick="downloadCard()">ğŸ’¾ ä¸‹è½½å¡ç‰Œ</button>
                        <button type="button" class="btn btn-secondary" onclick="resetForm()">ğŸ”„ é‡ç½®è¡¨å•</button>
                    </div>
                </form>
            </div>

            <div class="preview-section">
                <div class="card-preview">
                    <h3>ğŸ´ å¡ç‰Œé¢„è§ˆ</h3>
                    <canvas id="cardCanvas" class="card-canvas" width="400" height="600"></canvas>
                    <div id="status" class="status loading">ç­‰å¾…ç”Ÿæˆå¡ç‰Œ...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- åœ¨åŠ è½½Sunwellåº“ä¹‹å‰å®šä¹‰charså‡½æ•° -->
    <script>
        // ğŸ”§ ä¿®å¤ï¼šå®Œæ•´å®šä¹‰Sunwelléœ€è¦çš„charså‡½æ•°
        function chars(text) {
            if (!text || typeof text !== 'string') return [];
            return Array.from(text);
        }
        
        // å®Œæ•´çš„Unicodeå­—ç¬¦åˆ†ç±»å‡½æ•°
        chars.category = function(char) {
            if (!char || typeof char !== 'string' || char.length === 0) return 'Cn';
            
            const code = char.charCodeAt(0);
            
            // åŸºæœ¬æ‹‰ä¸å­—æ¯ (A-Z, a-z)
            if ((code >= 65 && code <= 90)) return 'Lu'; // Letter, uppercase
            if ((code >= 97 && code <= 122)) return 'Ll'; // Letter, lowercase
            
            // æ•°å­— (0-9)
            if (code >= 48 && code <= 57) return 'Nd'; // Number, decimal digit
            
            // ç©ºæ ¼å’Œæ§åˆ¶å­—ç¬¦
            if (code === 32 || code === 160) return 'Zs'; // Separator, space
            if (code < 32) return 'Cc'; // Other, control
            
            // å¸¸è§æ ‡ç‚¹ç¬¦å·
            if ((code >= 33 && code <= 47) || (code >= 58 && code <= 64) || 
                (code >= 91 && code <= 96) || (code >= 123 && code <= 126)) {
                return 'Po'; // Punctuation, other
            }
            
            // ä¸­æ–‡å­—ç¬¦èŒƒå›´
            if (code >= 0x4E00 && code <= 0x9FFF) return 'Lo'; // Letter, other (CJK)
            if (code >= 0x3400 && code <= 0x4DBF) return 'Lo'; // CJK Extension A
            if (code >= 0x20000 && code <= 0x2A6DF) return 'Lo'; // CJK Extension B
            if (code >= 0x2A700 && code <= 0x2B73F) return 'Lo'; // CJK Extension C
            if (code >= 0x2B740 && code <= 0x2B81F) return 'Lo'; // CJK Extension D
            if (code >= 0x2B820 && code <= 0x2CEAF) return 'Lo'; // CJK Extension E
            
            // ä¸­æ–‡æ ‡ç‚¹ç¬¦å·
            if ((code >= 0x3000 && code <= 0x303F) || // CJK Symbols and Punctuation
                (code >= 0xFF00 && code <= 0xFFEF)) { // Halfwidth and Fullwidth Forms
                return 'Po'; // Punctuation, other
            }
            
            // æ‹‰ä¸å­—ç¬¦æ‰©å±•
            if (code >= 0x0080 && code <= 0x024F) return 'Lo'; // Latin Extended
            
            // å…¶ä»–å¸¸è§Unicodeå—
            if (code >= 0x0370 && code <= 0x03FF) return 'Lo'; // Greek and Coptic
            if (code >= 0x0400 && code <= 0x04FF) return 'Lo'; // Cyrillic
            if (code >= 0x0590 && code <= 0x05FF) return 'Lo'; // Hebrew
            if (code >= 0x0600 && code <= 0x06FF) return 'Lo'; // Arabic
            
            // é»˜è®¤è¿”å›
            return 'Lo'; // Letter, other (æ›´å®‰å…¨çš„é»˜è®¤å€¼)
        };
        
        // å­—ç¬¦å®½åº¦è®¡ç®—å‡½æ•°
        chars.width = function(char) {
            if (!char) return 0;
            const code = char.charCodeAt(0);
            
            // ä¸­æ–‡å­—ç¬¦é€šå¸¸æ˜¯å…¨è§’å®½åº¦
            if (code >= 0x4E00 && code <= 0x9FFF) return 2;
            if (code >= 0x3000 && code <= 0x303F) return 2; // ä¸­æ–‡æ ‡ç‚¹
            if (code >= 0xFF00 && code <= 0xFFEF) return 2; // å…¨è§’å­—ç¬¦
            
            // è¥¿æ–‡å­—ç¬¦é€šå¸¸æ˜¯åŠè§’å®½åº¦
            return 1;
        };
        
        // æŒ‚è½½åˆ°å…¨å±€å¯¹è±¡
        window.chars = chars;
        
        // ğŸ”§ å…³é”®ä¿®å¤ï¼šå®šä¹‰Sunwelléœ€è¦çš„LineBreakerå…¨å±€å¯¹è±¡
        window.LineBreaker = function(text) {
            if (!text || typeof text !== 'string') return [];
            
            // ç®€å•çš„ä¸­æ–‡åˆ†è¡Œå™¨ - æŒ‰å­—ç¬¦åˆ†å‰²
            const breaks = [];
            for (let i = 0; i < text.length; i++) {
                breaks.push({
                    position: i,
                    required: false // å¯é€‰åˆ†è¡Œç‚¹
                });
            }
            
            return {
                nextBreak: function() {
                    return breaks.shift() || null;
                }
            };
        };
        
        // è°ƒè¯•æ¨¡å¼ä¸‹è¾“å‡ºå‡½æ•°ä¿¡æ¯
        console.log('âœ… charså‡½æ•°å·²å®šä¹‰:', typeof chars, typeof chars.category, typeof chars.width);
        console.log('âœ… LineBreakerå‡½æ•°å·²å®šä¹‰:', typeof LineBreaker);
        
        // ç¡®ä¿å…¨å±€å¯¹è±¡å¯è®¿é—®
        console.log('âœ… global.chars:', typeof window.chars);
        console.log('âœ… global.LineBreaker:', typeof window.LineBreaker);
    </script>
    
    <!-- å¼•å…¥Sunwellåº“ - ä½¿ç”¨browserç‰ˆæœ¬ -->
    <script src="./dist/sunwell.browser.js"></script>
    <script>
        // å…¨å±€å˜é‡
        let sunwell;
        let currentCardData = {};
        let uploadedImage = null;
        let debugMode = true; // å¯ç”¨è°ƒè¯•æ¨¡å¼

        // ğŸ”¥ ä¿®å¤ç‰ˆæœ¬çš„ç‚‰çŸ³å…³é”®è¯åˆ—è¡¨
        const hearthstoneKeywords = [
            'æˆ˜å¼', 'äº¡è¯­', 'å˜²è®½', 'é£æ€’', 'å†²é”‹', 'æ½œè¡Œ', 
            'è¿å‡»', 'æ²‰é»˜', 'å¥¥ç§˜', 'å†»ç»“', 'è¿‡è½½', 
            'æ³•æœ¯ä¼¤å®³', 'åœ£ç›¾', 'ä¼ è¯´', 'æŠ‰æ‹©', 'æ¿€åŠ±', 
            'å‘ç°', 'ä»»åŠ¡', 'è¿›åŒ–', 'å¸è¡€', 'å›å“', 'å‰§æ¯’',
            'æ³•æœ¯å¼ºåº¦', 'ç”Ÿå‘½çªƒå–', 'æ‹›å‹Ÿ', 'çªè¢­', 'ç£åŠ›',
            'è¶…æ€', 'åŒç”Ÿæ³•æœ¯', 'å¤ç”Ÿ', 'ç¥ˆæ±‚', 'æµæ”¾', 'ä¼‘çœ '
        ];

        // ğŸ›¡ï¸ å®‰å…¨çš„å…³é”®è¯å¤„ç†å‡½æ•° - å®Œå…¨é‡å†™é¿å…æ— é™å¾ªç¯
        function safeProcessKeywords(text) {
            if (!text || typeof text !== 'string') {
                return { processedText: text || '', keywords: [] };
            }

            let result = text;
            let foundKeywords = [];
            
            try {
                // ä½¿ç”¨ç®€å•çš„å­—ç¬¦ä¸²æ›¿æ¢ï¼Œé¿å…å¤æ‚æ­£åˆ™è¡¨è¾¾å¼
                hearthstoneKeywords.forEach(keyword => {
                    if (!keyword) return;
                    
                    const searchPattern = keyword + 'ï¼š';
                    const replacePattern = `<b>${keyword}</b>ï¼š`; // ğŸ”§ ä¿®å¤ï¼šä½¿ç”¨Sunwellæ”¯æŒçš„<b>æ ‡ç­¾
                    
                    // ç®€å•çš„å…¨å±€æ›¿æ¢ï¼Œé˜²æ­¢æ— é™å¾ªç¯
                    let lastResult = result;
                    result = result.split(searchPattern).join(replacePattern);
                    
                    // å¦‚æœæœ‰æ›¿æ¢ï¼Œè®°å½•å…³é”®è¯
                    if (result !== lastResult) {
                        foundKeywords.push(keyword);
                    }
                });
                
                return { processedText: result, keywords: foundKeywords };
            } catch (error) {
                console.error('å…³é”®è¯å¤„ç†é”™è¯¯:', error);
                return { processedText: text, keywords: [] };
            }
        }

        // ğŸ›¡ï¸ å®‰å…¨çš„æ–‡æœ¬åˆ†è¡Œå‡½æ•° - ä¿®å¤ç‰ˆæœ¬
        function safeTextSplit(text, maxWidth, fontSize) {
            if (!text || typeof text !== 'string') {
                return [''];
            }

            // ğŸ”§ ä¿®å¤ï¼šåŸºäºç‚‰çŸ³å¡ç‰Œå®é™…è¡¨ç°è®¾ç½®ç²¾ç¡®çš„æ¢è¡Œå‚æ•°
            // æ ¹æ®å›¾ç‰‡åˆ†æï¼Œç†æƒ³çš„ç¬¬ä¸€è¡Œé•¿åº¦åº”è¯¥æ˜¯11ä¸ªå­—ç¬¦ï¼š"æˆ˜å¼ï¼šå‘ç°ä¸€å¼ æ³•æœ¯ç‰Œã€‚å½“"
            const targetCharsPerLine = 11; // å›ºå®šä¸º11ä¸ªå­—ç¬¦ï¼Œç¡®ä¿åœ¨æ­£ç¡®ä½ç½®æ¢è¡Œ
            
            // è°ƒè¯•ä¿¡æ¯
            console.log(`ğŸ“ åˆ†è¡Œå‚æ•°: maxWidth=${maxWidth}, fontSize=${fontSize}, targetCharsPerLine=${targetCharsPerLine}`);
            console.log(`ğŸ“ åŸå§‹æ–‡æœ¬: "${text}"`);
            console.log(`ğŸ“ æ–‡æœ¬ä¸­æ˜¯å¦åŒ…å«<b>æ ‡ç­¾:`, text.includes('<b>'));
            
            const lines = [];
            let currentLine = '';
            let i = 0;
            
            // å®‰å…¨è®¡æ•°å™¨
            const safeLimit = text.length + 50;
            let iterations = 0;
            
            while (i < text.length && lines.length < 4 && iterations < safeLimit) {
                iterations++;
                
                // ğŸ”§ ä¿®å¤ï¼šå¤„ç†ç²—ä½“æ ‡è®°åŠåç»­å­—ç¬¦
                if (text.substr(i, 3) === '<b>') {
                    console.log(`ğŸ“ åœ¨åˆ†å‰²ä¸­æ‰¾åˆ°<b>æ ‡ç­¾åœ¨ä½ç½® ${i}`);
                    const endIndex = text.indexOf('</b>', i);
                    if (endIndex > i) {
                        const boldBlock = text.substring(i, endIndex + 4);
                        const boldText = text.substring(i + 3, endIndex);
                        console.log(`ğŸ“ åˆ†å‰²ä¸­çš„ç²—ä½“å—: "${boldBlock}", ç²—ä½“æ–‡æœ¬: "${boldText}"`);
                        
                        // ğŸ”§ å…³é”®ä¿®å¤ï¼šæˆ˜å¼ç­‰å…³é”®è¯åçš„å†’å·ä¸åº”å¯¼è‡´æ¢è¡Œ
                        let estimatedLength = boldText.length;
                        const nextCharIndex = endIndex + 4;
                        let nextChar = '';
                        if (nextCharIndex < text.length) {
                            nextChar = text[nextCharIndex];
                            if (/[ï¼šï¼Œã€‚ï¼ï¼Ÿï¼›]/.test(nextChar)) {
                                estimatedLength += 1; // æ ‡ç‚¹ç¬¦å·è®¡å…¥é•¿åº¦
                            }
                        }
                        
                        // ç‰¹æ®Šå¤„ç†ï¼šå…³é”®è¯+å†’å·çš„ç»„åˆä¼˜å…ˆä¿æŒåœ¨åŒä¸€è¡Œ
                        const isKeywordColon = /^(æˆ˜å¼|äº¡è¯­|å˜²è®½|å†²é”‹|æ½œè¡Œ|åœ£ç›¾|å‰§æ¯’|é£æ€’|ç”Ÿå‘½å·å–|æ³•æœ¯ä¼¤å®³|è¿‡è½½|è¿å‡»|å¥¥ç§˜|ä»»åŠ¡|å‘ç°)$/.test(boldText) && nextChar === 'ï¼š';
                        
                        // ğŸ”§ ä½¿ç”¨ç²¾ç¡®çš„é•¿åº¦æ£€æŸ¥ï¼šç§»é™¤æ ‡ç­¾è®¡ç®—å®é™…å­—ç¬¦æ•°
                        const currentEffectiveLength = currentLine.replace(/<\/?b>/g, '').length;
                        
                        if (currentEffectiveLength + estimatedLength > targetCharsPerLine && currentLine && !isKeywordColon) {
                            lines.push(currentLine);
                            currentLine = boldBlock;
                        } else {
                            currentLine += boldBlock;
                        }
                        i = endIndex + 4;
                        continue;
                    }
                }
                
                // æ™®é€šå­—ç¬¦å¤„ç†
                const char = text[i];
                
                // ğŸ”§ ç‰¹æ®Šå¤„ç†ï¼šå†’å·ä¼˜å…ˆä¸å‰é¢å†…å®¹ä¿æŒåœ¨åŒä¸€è¡Œ
                const isColonAfterKeyword = char === 'ï¼š' && currentLine.includes('</b>');
                
                // ğŸ”§ ä½¿ç”¨æ›´ç²¾ç¡®çš„é•¿åº¦æ£€æŸ¥ï¼ˆè€ƒè™‘å­—ç¬¦çš„å®é™…æ˜¾ç¤ºå®½åº¦è€Œéæ•°é‡ï¼‰
                const effectiveLength = currentLine.replace(/<\/?b>/g, '').length; // ç§»é™¤æ ‡ç­¾è®¡ç®—å®é™…å­—ç¬¦æ•°
                
                if (effectiveLength >= targetCharsPerLine && currentLine && !isColonAfterKeyword) {
                    lines.push(currentLine);
                    currentLine = char;
                } else {
                    currentLine += char;
                }
                i++;
            }
            
            if (currentLine) {
                lines.push(currentLine);
            }
            
            console.log(`ğŸ“ æ–‡æœ¬åˆ†å‰²å®Œæˆï¼Œå…±${lines.length}è¡Œ:`);
            lines.forEach((line, index) => {
                console.log(`ğŸ“ ç¬¬${index}è¡Œ: "${line}"`);
                console.log(`ğŸ“ ç¬¬${index}è¡ŒåŒ…å«<b>æ ‡ç­¾:`, line.includes('<b>'));
            });
            
            return lines.length > 0 ? lines : [''];
        }

        // ğŸ›¡ï¸ å®‰å…¨çš„ä¸­æ–‡å¡ç‰Œåç§°æ¸²æŸ“ - å¢å¼ºç‰ˆ
        function safeRenderChineseName(canvas, name) {
            if (!canvas || !name) return;
            
            const ctx = canvas.getContext('2d');
            
            try {
                // ğŸ”§ ä¿®å¤ï¼šæ ¹æ®Sunwellå¡ç‰Œè§„æ ¼è°ƒæ•´åç§°ä½ç½®
                const nameX = 200; // å¡ç‰Œåç§°å±…ä¸­ä½ç½® (400pxå¡ç‰Œçš„ä¸­å¿ƒ)
                const nameY = 70;  // åç§°æ¡ä½ç½® (è°ƒæ•´åˆ°æ›´å‡†ç¡®çš„ä½ç½®)
                const clearWidth = 350; // æ‰©å¤§æ¸…é™¤åŒºåŸŸå®½åº¦
                const clearHeight = 50; // æ‰©å¤§æ¸…é™¤åŒºåŸŸé«˜åº¦
                
                // ä¿å­˜å½“å‰çŠ¶æ€
                ctx.save();
                
                // æ¸…é™¤åç§°åŒºåŸŸ (ä½¿ç”¨é€æ˜è‰²)
                ctx.globalCompositeOperation = 'destination-out';
                ctx.fillRect(nameX - clearWidth/2, nameY - clearHeight/2, clearWidth, clearHeight);
                
                // æ¢å¤æ­£å¸¸ç»˜åˆ¶æ¨¡å¼
                ctx.globalCompositeOperation = 'source-over';
                
                // è®¾ç½®å¼ºåŒ–çš„å­—ä½“æ ·å¼
                ctx.fillStyle = '#FFFFFF'; // ç™½è‰²æ–‡å­—
                ctx.strokeStyle = '#000000'; // é»‘è‰²æè¾¹
                ctx.lineWidth = 4; // æ›´ç²—çš„æè¾¹
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                
                const fontSize = 32; // æ›´å¤§çš„å­—ä½“
                ctx.font = `bold ${fontSize}px "ç»å…¸éš¶å˜ç®€", Arial, sans-serif`;
                
                // å…ˆç»˜åˆ¶åšé‡çš„æè¾¹
                ctx.strokeText(name, nameX, nameY);
                // å†ç»˜åˆ¶æ–‡å­—
                ctx.fillText(name, nameX, nameY);
                
                // æ¢å¤çŠ¶æ€
                ctx.restore();
                
                console.log(`âœ… ä¸­æ–‡å¡ç‰Œåç§°æ¸²æŸ“æˆåŠŸ: ${name} (ä½ç½®: ${nameX}, ${nameY})`);
            } catch (error) {
                console.error('ä¸­æ–‡å¡ç‰Œåç§°æ¸²æŸ“å¤±è´¥:', error);
            }
        }

        // ğŸ›¡ï¸ å®‰å…¨çš„ä¸­æ–‡æ–‡æœ¬æ¸²æŸ“
        function safeRenderChineseText(canvas, textConfig) {
            if (!canvas || !textConfig) return;
            
            const ctx = canvas.getContext('2d');
            const { text, fontSize = 20, lines, keywords = [], isPremium = false } = textConfig;
            
            try {
                // ğŸ”§ æ–°åŠŸèƒ½ï¼šæ ¹æ®å¡ç‰Œç±»å‹åŠ¨æ€è°ƒæ•´æ–‡å­—é¢œè‰²å’Œæè¾¹
                // é‡‘è‰²ä¼ è¯´/å²è¯—ï¼šç™½è‰²æ–‡å­— + æ·±è‰²æè¾¹ï¼Œæ™®é€šå¡ç‰Œï¼šé»‘è‰²æ–‡å­—æ— æè¾¹
                const textColor = isPremium ? '#FFFFFF' : '#000000';
                const useStroke = isPremium; // é‡‘è‰²å¡ç‰Œä½¿ç”¨æè¾¹å¢å¼ºå¯è¯»æ€§
                
                ctx.fillStyle = textColor;
                if (useStroke) {
                    ctx.strokeStyle = 'rgba(0, 0, 0, 0.8)'; // åŠé€æ˜é»‘è‰²æè¾¹
                    ctx.lineWidth = 1.5; // è½»å¾®æè¾¹
                }
                ctx.textAlign = 'left';
                ctx.textBaseline = 'ideographic';
                
                console.log(`ğŸ¨ æ–‡å­—è®¾ç½®: isPremium=${isPremium}, textColor=${textColor}, stroke=${useStroke}`);
                
                const baseX = 88;
                const baseY = 385;
                const lineHeight = Math.round(fontSize * 1.3);
                
                console.log('ğŸ” safeRenderChineseText å¼€å§‹æ¸²æŸ“ï¼Œæ€»è¡Œæ•°:', lines.length);
                console.log('ğŸ” æ‰€æœ‰è¡Œå†…å®¹:', lines);
                
                lines.forEach((line, lineIndex) => {
                    if (lineIndex >= 4) return; // æœ€å¤š4è¡Œ
                    
                    console.log(`ğŸ” å¤„ç†ç¬¬${lineIndex}è¡Œ: "${line}"`);
                    console.log(`ğŸ” è¡Œä¸­æ˜¯å¦åŒ…å«<b>æ ‡ç­¾:`, line.includes('<b>'));
                    
                    let currentX = baseX;
                    const y = baseY + fontSize + (lineIndex * lineHeight);
                    
                    // åº”ç”¨ç¼©è¿›
                    if (lineIndex === 2) currentX += 38;
                    if (lineIndex === 3) currentX += 40;
                    
                    let i = 0;
                    const safeLimit = line.length + 10;
                    let iterations = 0;
                    
                    while (i < line.length && iterations < safeLimit) {
                        iterations++;
                        
                        if (line.substr(i, 3) === '<b>') {
                            console.log(`ğŸ” æ‰¾åˆ°<b>æ ‡ç­¾åœ¨ä½ç½® ${i}`);
                            const endIndex = line.indexOf('</b>', i);
                            console.log(`ğŸ” æ‰¾åˆ°</b>æ ‡ç­¾åœ¨ä½ç½® ${endIndex}`);
                            if (endIndex > i) {
                                const boldText = line.substring(i + 3, endIndex);
                                console.log(`ğŸ” æå–ç²—ä½“æ–‡æœ¬: "${boldText}"`);
                                
                                // è®¾ç½®ç²—ä½“ï¼ˆä½¿ç”¨ä¸å½“å‰ä¸Šä¸‹æ–‡ç›¸åŒçš„é¢œè‰²ï¼‰
                                ctx.font = `bold ${fontSize}px "ç»å…¸éš¶å˜ç®€", Arial, sans-serif`;
                                ctx.fillStyle = textColor; // ç¡®ä¿ç²—ä½“ä½¿ç”¨æ­£ç¡®é¢œè‰²
                                
                                // å…ˆç»˜åˆ¶æè¾¹ï¼ˆå¦‚æœéœ€è¦ï¼‰ï¼Œå†ç»˜åˆ¶å¡«å……
                                if (useStroke) {
                                    ctx.strokeText(boldText, currentX, y);
                                }
                                ctx.fillText(boldText, currentX, y);
                                currentX += ctx.measureText(boldText).width;
                                
                                console.log(`ğŸ” ç²—ä½“æ–‡æœ¬å·²æ¸²æŸ“ï¼Œè·³è½¬åˆ°ä½ç½® ${endIndex + 4}`);
                                i = endIndex + 4;
                                continue;
                            } else {
                                console.log(`ğŸ” âš ï¸ æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„</b>æ ‡ç­¾`);
                            }
                        }
                        
                        // æ™®é€šå­—ç¬¦
                        const char = line[i];
                        console.log(`ğŸ” æ¸²æŸ“æ™®é€šå­—ç¬¦: "${char}" åœ¨ä½ç½® ${i}`);
                        ctx.font = `${fontSize}px "ç»å…¸éš¶å˜ç®€", Arial, sans-serif`;
                        ctx.fillStyle = textColor; // ç¡®ä¿æ™®é€šå­—ç¬¦ä½¿ç”¨æ­£ç¡®é¢œè‰²
                        
                        // å…ˆç»˜åˆ¶æè¾¹ï¼ˆå¦‚æœéœ€è¦ï¼‰ï¼Œå†ç»˜åˆ¶å¡«å……
                        if (useStroke) {
                            ctx.strokeText(char, currentX, y);
                        }
                        ctx.fillText(char, currentX, y);
                        currentX += ctx.measureText(char).width;
                        i++;
                    }
                });
                
                console.log(`âœ… ä¸­æ–‡æ–‡æœ¬æ¸²æŸ“æˆåŠŸ: ${lines.length}è¡Œ, ${keywords.length}ä¸ªå…³é”®è¯`);
            } catch (error) {
                console.error('ä¸­æ–‡æ–‡æœ¬æ¸²æŸ“å¤±è´¥:', error);
            }
        }

        // å…¨å±€é”™è¯¯å¤„ç†å™¨
        window.addEventListener('error', function(event) {
            console.error('å…¨å±€JavaScripté”™è¯¯:', event.error);
            updateStatus('å‘ç”ŸJavaScripté”™è¯¯: ' + event.message, 'error');
        });

        // æœªå¤„ç†çš„Promiseæ‹’ç»
        window.addEventListener('unhandledrejection', function(event) {
            console.error('æœªå¤„ç†çš„Promiseæ‹’ç»:', event.reason);
            updateStatus('Promiseé”™è¯¯: ' + event.reason, 'error');
        });

        // è°ƒè¯•æ—¥å¿—å‡½æ•°
        function debugLog(message, data) {
            if (debugMode) {
                console.log('[DEBUG] ' + message, data || '');
            }
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            debugLog('DOMåŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...');
            try {
                // ç­‰å¾…Sunwellåº“åŠ è½½å®Œæˆ
                waitForSunwell().then(function() {
                    debugLog('Sunwellåº“åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–');
                    initializeSunwell();
                    setupEventListeners();
                    loadTemplate('legendary'); // é»˜è®¤åŠ è½½ä¼ è¯´æ¨¡æ¿
                }).catch(function(error) {
                    console.error('ç­‰å¾…Sunwellåº“åŠ è½½å¤±è´¥:', error);
                    updateStatus('Sunwellåº“åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'error');
                });
            } catch (error) {
                console.error('åˆå§‹åŒ–è¿‡ç¨‹ä¸­å‡ºé”™:', error);
                updateStatus('åˆå§‹åŒ–å¤±è´¥: ' + error.message, 'error');
            }
        });
        
        // ç­‰å¾…Sunwellåº“åŠ è½½å®Œæˆ
        function waitForSunwell() {
            return new Promise(function(resolve, reject) {
                var maxAttempts = 50; // æœ€å¤šç­‰å¾…5ç§’
                var attempts = 0;
                
                function checkSunwell() {
                    debugLog('æ£€æŸ¥Sunwellåº“ï¼Œå°è¯•æ¬¡æ•°: ' + (attempts + 1));
                    if (typeof Sunwell !== 'undefined') {
                        debugLog('Sunwellåº“å·²åŠ è½½');
                        resolve();
                    } else if (attempts < maxAttempts) {
                        attempts++;
                        setTimeout(checkSunwell, 100);
                    } else {
                        debugLog('Sunwellåº“åŠ è½½è¶…æ—¶');
                        reject(new Error('Sunwellåº“åŠ è½½è¶…æ—¶'));
                    }
                }
                
                checkSunwell();
            });
        }

        // åˆå§‹åŒ–Sunwellåº“
        function initializeSunwell() {
            try {
                debugLog('å¼€å§‹åˆå§‹åŒ–Sunwellåº“');
                if (typeof Sunwell === 'undefined') {
                    throw new Error('Sunwellåº“æœªåŠ è½½');
                }

                debugLog('åˆ›å»ºSunwellå®ä¾‹');
                sunwell = new Sunwell({
                    assetFolder: './assets/',
                    titleFont: "Arial, sans-serif", // ä½¿ç”¨å®‰å…¨å­—ä½“é¿å…åŠ è½½é—®é¢˜
                    bodyFontRegular: "Arial, sans-serif",
                    bodyFontItalic: "Arial, sans-serif",  
                    bodyFontBold: "Arial, sans-serif",
                    bodyFontBoldItalic: "Arial, sans-serif",
                    bodyFontSize: 1, // è®¾ç½®æå°å­—ä½“è®©æ–‡æœ¬ä¸å¯è§
                    bodyLineHeight: 1,
                    bodyFontOffset: {x: -9999, y: -9999}, // ç§»å‡ºå¯è§†åŒºåŸŸ
                    gemFont: "Arial, sans-serif",
                    nameFont: "Arial, sans-serif", // ç¡®ä¿åç§°å­—ä½“ä¹Ÿè®¾ç½®
                    raceFont: "Arial, sans-serif", // ç§æ—å­—ä½“
                    drawTimeout: 30000, // å¢åŠ è¶…æ—¶æ—¶é—´åˆ°30ç§’
                    debug: false // ç¦ç”¨Sunwellè°ƒè¯•ä»¥å‡å°‘å¹²æ‰°
                });
                
                debugLog('Sunwellå®ä¾‹åˆ›å»ºæˆåŠŸ', sunwell);
                updateStatus('Sunwellåº“åˆå§‹åŒ–æˆåŠŸ', 'success');
            } catch (error) {
                console.error('åˆå§‹åŒ–Sunwellæ—¶å‡ºé”™:', error);
                updateStatus('Sunwellåº“åŠ è½½å¤±è´¥: ' + error.message, 'error');
                throw error;
            }
        }

        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            const form = document.getElementById('cardForm');
            const inputs = form.querySelectorAll('input, select, textarea');
            
            inputs.forEach(input => {
                input.addEventListener('input', debounce(generateCard, 500));
                input.addEventListener('change', generateCard);
            });
        }

        // é˜²æŠ–å‡½æ•°
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // å¤„ç†å›¾ç‰‡ä¸Šä¼ 
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    uploadedImage = e.target.result;
                    const preview = document.getElementById('imagePreview');
                    const uploadText = document.getElementById('uploadText');
                    
                    preview.src = uploadedImage;
                    preview.style.display = 'block';
                    uploadText.style.display = 'none';
                    
                    generateCard();
                };
                reader.readAsDataURL(file);
            }
        }

        // åŠ è½½é¢„è®¾æ¨¡æ¿
        function loadTemplate(templateType) {
            const templates = {
                legendary: {
                    cardName: 'é¾™ç‹ç›é‡Œè‹Ÿæ–¯',
                    cardText: 'æˆ˜å¼ï¼šå‘ç°ä¸€å¼ æ³•æœ¯ç‰Œã€‚å½“ä½ åœ¨æœ¬å›åˆä¸­æ–½æ”¾å®ƒæ—¶ï¼Œå†æ¬¡æ–½æ”¾å®ƒã€‚',
                    cost: 9,
                    attack: 4,
                    health: 12,
                    cardClass: 'NEUTRAL',
                    rarity: 'LEGENDARY',
                    cardType: 'MINION',
                    race: 'DRAGON',
                    cardSet: 'EXPERT1'
                },
                epic: {
                    cardName: 'çƒˆç„°é£æš´',
                    cardText: 'æˆ˜å¼ï¼šå¯¹æ‰€æœ‰æ•Œæ–¹éšä»é€ æˆ2ç‚¹ä¼¤å®³ã€‚äº¡è¯­ï¼šå¬å”¤ä¸€ä¸ª2/2çš„ç«å…ƒç´ ã€‚',
                    cost: 7,
                    attack: 5,
                    health: 4,
                    cardClass: 'MAGE',
                    rarity: 'EPIC',
                    cardType: 'MINION',
                    race: 'ELEMENTAL',
                    cardSet: 'EXPERT1'
                },
                rare: {
                    cardName: 'éœœä¹‹å“€ä¼¤',
                    cardText: 'å˜²è®½ï¼šæ•Œæ–¹éšä»å¿…é¡»å…ˆæ”»å‡»å…·æœ‰å˜²è®½çš„éšä»ã€‚é£æ€’ï¼šå¯ä»¥æ”»å‡»ä¸¤æ¬¡ã€‚',
                    cost: 6,
                    attack: 4,
                    health: 5,
                    cardClass: 'WARRIOR',
                    rarity: 'RARE',
                    cardType: 'MINION',
                    race: '',
                    cardSet: 'EXPERT1'
                },
                random: generateRandomCard()
            };

            const template = templates[templateType];
            if (template) {
                Object.keys(template).forEach(key => {
                    const element = document.getElementById(key);
                    if (element) {
                        element.value = template[key];
                    }
                });
                generateCard();
            }
        }

        // ç”Ÿæˆéšæœºå¡ç‰Œæ•°æ®
        function generateRandomCard() {
            const names = ['ç¥ç§˜æ³•å¸ˆ', 'å‹‡æ•¢æˆ˜å£«', 'æš—å½±åˆºå®¢', 'å…‰æ˜å®ˆæŠ¤è€…', 'å…ƒç´ å¬å”¤å¸ˆ', 'é¾™æ—é¢†ä¸»', 'æœºæ¢°å·¥åŒ ', 'é‡å…½é©¯æœè€…'];
            const classes = ['DRUID', 'HUNTER', 'MAGE', 'PALADIN', 'PRIEST', 'ROGUE', 'SHAMAN', 'WARLOCK', 'WARRIOR', 'NEUTRAL'];
            const rarities = ['COMMON', 'RARE', 'EPIC', 'LEGENDARY'];
            const types = ['MINION', 'SPELL', 'WEAPON'];
            const races = ['', 'BEAST', 'DEMON', 'DRAGON', 'ELEMENTAL', 'MECH', 'MURLOC', 'PIRATE'];
            const effects = ['æˆ˜å¼ï¼šæŠ½ä¸€å¼ ç‰Œã€‚', 'äº¡è¯­ï¼šå¬å”¤ä¸€ä¸ª1/1çš„å°å…µã€‚', 'å˜²è®½', 'å†²é”‹', 'æ½œè¡Œ', 'æ³•æœ¯ä¼¤å®³+1'];

            return {
                cardName: names[Math.floor(Math.random() * names.length)],
                cardText: effects[Math.floor(Math.random() * effects.length)],
                cost: Math.floor(Math.random() * 10) + 1,
                attack: Math.floor(Math.random() * 8) + 1,
                health: Math.floor(Math.random() * 8) + 1,
                cardClass: classes[Math.floor(Math.random() * classes.length)],
                rarity: rarities[Math.floor(Math.random() * rarities.length)],
                cardType: types[Math.floor(Math.random() * types.length)],
                race: races[Math.floor(Math.random() * races.length)],
                cardSet: 'EXPERT1'
            };
        }

        // ğŸ›¡ï¸ å®‰å…¨çš„å¡ç‰Œç”Ÿæˆå‡½æ•° - å®Œå…¨é‡å†™
        function generateCard() {
            debugLog('å¼€å§‹ç”Ÿæˆå¡ç‰Œ...');
            updateStatus('æ­£åœ¨ç”Ÿæˆå¡ç‰Œ...', 'loading');
            
            try {
                // æ£€æŸ¥Sunwellåº“æ˜¯å¦å·²åˆå§‹åŒ–
                if (!sunwell) {
                    debugLog('Sunwellåº“æœªåˆå§‹åŒ–');
                    updateStatus('Sunwellåº“æœªåˆå§‹åŒ–ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'error');
                    return;
                }
                
                // æ”¶é›†è¡¨å•æ•°æ®
                currentCardData = collectFormData();
                debugLog('æ”¶é›†åˆ°çš„å¡ç‰Œæ•°æ®:', currentCardData);
                
                // éªŒè¯å¿…è¦å­—æ®µ
                if (!currentCardData.name || !currentCardData.name.trim()) {
                    updateStatus('è¯·è¾“å…¥å¡ç‰Œåç§°', 'error');
                    return;
                }
                
                // ä¿å­˜åŸå§‹æ–‡æœ¬ï¼Œä½†ç›´æ¥ä½¿ç”¨ä¸­æ–‡åç§°å’Œæ–‡æœ¬
                const originalText = currentCardData.text;
                const originalName = currentCardData.name;
                
                // ğŸ”§ å…³é”®ä¿®å¤ï¼šä¸å†æ›¿æ¢ä¸ºè‹±æ–‡ï¼Œç›´æ¥ä½¿ç”¨ä¸­æ–‡å†…å®¹
                // Sunwellç°åœ¨å¯ä»¥å¤„ç†ä¸­æ–‡ï¼Œå› ä¸ºæˆ‘ä»¬å·²ä¿®å¤charså‡½æ•°
                
                const canvas = document.getElementById('cardCanvas');
                if (!canvas) {
                    updateStatus('æ‰¾ä¸åˆ°ç”»å¸ƒå…ƒç´ ', 'error');
                    return;
                }
                
                // å¢å¼ºçš„è¶…æ—¶å’Œé”™è¯¯å¤„ç†
                let isCompleted = false;
                const timeoutId = setTimeout(() => {
                    if (!isCompleted) {
                        updateStatus('å¡ç‰Œç”Ÿæˆè¶…æ—¶ï¼Œè¯·æ£€æŸ¥æ–‡æœ¬å†…å®¹æˆ–é‡è¯•', 'error');
                        // æ˜¾ç¤ºé”™è¯¯æç¤º
                        const ctx = canvas.getContext('2d');
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        ctx.fillStyle = '#ff0000';
                        ctx.font = '20px Arial';
                        ctx.fillText('æ¸²æŸ“è¶…æ—¶ - è¯·æ£€æŸ¥æ–‡æœ¬åé‡è¯•', 20, 100);
                    }
                }, 20000);
                
                // ä½¿ç”¨Sunwellæ¸²æŸ“å¡ç‰Œ
                const isPremium = (currentCardData.rarity === 'LEGENDARY' || currentCardData.rarity === 'EPIC');
                
                console.log('ğŸ” ä¼ ç»™Sunwellçš„å¡ç‰Œæ•°æ®:', currentCardData);
                console.log('ğŸ” ç‰¹åˆ«æ˜¯æ–‡æœ¬å­—æ®µ:', currentCardData.text);
                
                const card = sunwell.createCard(
                    currentCardData,
                    400,
                    isPremium,
                    canvas,
                    function(renderedCanvas) {
                        isCompleted = true;
                        clearTimeout(timeoutId);
                        
                        debugLog('å¡ç‰ŒåŸºç¡€æ¸²æŸ“å®Œæˆ');
                        
                        try {
                            // å®‰å…¨çš„ä¸­æ–‡æ–‡æœ¬å¤„ç†
                            if (renderedCanvas && originalText && originalText.trim()) {
                                // ç›´æ¥ä½¿ç”¨å·²å¤„ç†çš„æ–‡æœ¬ï¼Œé¿å…é‡å¤å¤„ç†
                                const processedText = currentCardData.text;
                                const textLength = processedText.length;
                                
                                // æ™ºèƒ½å­—ä½“é€‰æ‹©
                                let fontSize = 20;
                                if (textLength <= 15) fontSize = 23;
                                else if (textLength <= 30) fontSize = 21;
                                else if (textLength <= 50) fontSize = 19;
                                
                                // ğŸ”§ ä½¿ç”¨å®é™…æµ‹é‡çš„æ–‡æœ¬æ¡†å®½åº¦ï¼ˆç‚‰çŸ³å¡ç‰Œæ–‡æœ¬åŒºåŸŸçº¦215pxï¼‰
                                const lines = safeTextSplit(processedText, 215, fontSize);
                                
                                const textConfig = {
                                    text: originalText,
                                    processedText: processedText,
                                    fontSize: fontSize,
                                    lines: lines,
                                    isPremium: isPremium  // ğŸ”§ ä¼ é€’é‡‘è‰²å¡ç‰ŒçŠ¶æ€
                                };
                                
                                safeRenderChineseText(renderedCanvas, textConfig);
                                
                                // ğŸ”§ ä¿®å¤ï¼šä¸å†éœ€è¦æ‰‹åŠ¨æ¸²æŸ“ä¸­æ–‡åç§°ï¼ŒSunwellå·²ç›´æ¥æ¸²æŸ“
                                console.log(`âœ… å¡ç‰Œåç§°ç”±Sunwellç›´æ¥æ¸²æŸ“: "${originalName}"`);
                                
                                const colorInfo = isPremium ? 'ç™½è‰²æ–‡å­—(é‡‘è‰²)' : 'é»‘è‰²æ–‡å­—(æ™®é€š)';
                                updateStatus(`å¡ç‰Œç”ŸæˆæˆåŠŸï¼${fontSize}pxå­—ä½“ï¼Œ${lines.length}è¡Œï¼Œ${colorInfo}`, 'success');
                            } else {
                                updateStatus('å¡ç‰Œç”ŸæˆæˆåŠŸï¼', 'success');
                            }
                        } catch (textError) {
                            console.error('ä¸­æ–‡æ–‡æœ¬å¤„ç†å¤±è´¥:', textError);
                            updateStatus('å¡ç‰ŒåŸºç¡€æ¸²æŸ“æˆåŠŸï¼Œä¸­æ–‡æ–‡æœ¬å¤„ç†å¤±è´¥', 'success');
                        }
                    }
                );
                
            } catch (error) {
                debugLog('ç”Ÿæˆå¡ç‰Œæ—¶å‡ºé”™:', error);
                console.error('ç”Ÿæˆå¡ç‰Œæ—¶å‡ºé”™:', error);
                updateStatus('ç”Ÿæˆå¡ç‰Œæ—¶å‡ºé”™: ' + error.message, 'error');
            }
        }

        // æ”¶é›†è¡¨å•æ•°æ®
        function collectFormData() {
            debugLog('å¼€å§‹æ”¶é›†è¡¨å•æ•°æ®');
            
            try {
                const formData = new FormData(document.getElementById('cardForm'));
                
                // ğŸ”§ å¤„ç†å¡ç‰Œæ–‡æœ¬ä¸­çš„å…³é”®è¯
                let cardText = formData.get('cardText') || '';
                console.log('ğŸ” åŸå§‹æ–‡æœ¬:', cardText);
                if (cardText) {
                    const processedResult = safeProcessKeywords(cardText);
                    cardText = processedResult.processedText;
                    console.log('ğŸ” å¤„ç†åæ–‡æœ¬:', cardText);
                    console.log('ğŸ” æ‰¾åˆ°çš„å…³é”®è¯:', processedResult.foundKeywords);
                }
                
                const cardData = {
                    id: 'CUSTOM_' + Date.now(),
                    name: formData.get('cardName') || 'æœªå‘½åå¡ç‰Œ',
                    text: cardText,
                    cost: parseInt(formData.get('cost')) || 0,
                    attack: parseInt(formData.get('attack')) || 0,
                    health: parseInt(formData.get('health')) || 1,
                    cardClass: formData.get('cardClass') || 'NEUTRAL',
                    rarity: formData.get('rarity') || 'COMMON',
                    type: formData.get('cardType') || 'MINION',
                    race: formData.get('race') || '',
                    set: formData.get('cardSet') || 'EXPERT1',
                    collectible: true,
                    texture: uploadedImage,
                    collectionText: cardText,
                    flavor: '',
                    elite: false,
                    silenced: false,
                    hideStats: false,
                    costsHealth: false,
                    armor: 0
                };
                
                // æ ¹æ®å¡ç‰Œç±»å‹è°ƒæ•´å±æ€§
                if (cardData.type === 'SPELL') {
                    delete cardData.attack;
                    delete cardData.health;
                } else if (cardData.type === 'WEAPON') {
                    cardData.durability = cardData.health;
                    delete cardData.health;
                }

                // è®¾ç½®ä¼ è¯´å¡ç‰Œçš„ç²¾è‹±æ ‡è®°
                cardData.elite = (cardData.rarity === 'LEGENDARY');

                debugLog('æœ€ç»ˆå¡ç‰Œæ•°æ®:', cardData);
                return cardData;
            } catch (error) {
                debugLog('æ”¶é›†è¡¨å•æ•°æ®æ—¶å‡ºé”™:', error);
                console.error('æ”¶é›†è¡¨å•æ•°æ®æ—¶å‡ºé”™:', error);
                throw error;
            }
        }

        // ä¸‹è½½å¡ç‰Œ
        function downloadCard() {
            const canvas = document.getElementById('cardCanvas');
            const link = document.createElement('a');
            const cardName = document.getElementById('cardName').value || 'è‡ªå®šä¹‰å¡ç‰Œ';
            
            link.download = `${cardName}_ç‚‰çŸ³å¡ç‰Œ.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
            
            updateStatus('å¡ç‰Œå·²ä¸‹è½½ï¼', 'success');
        }

        // é‡ç½®è¡¨å•
        function resetForm() {
            document.getElementById('cardForm').reset();
            document.getElementById('imagePreview').style.display = 'none';
            document.getElementById('uploadText').style.display = 'block';
            uploadedImage = null;
            
            const canvas = document.getElementById('cardCanvas');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            updateStatus('è¡¨å•å·²é‡ç½®', 'success');
        }

        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        function updateStatus(message, type) {
            debugLog('æ›´æ–°çŠ¶æ€:', { message, type });
            try {
                const statusElement = document.getElementById('status');
                if (!statusElement) {
                    debugLog('æ‰¾ä¸åˆ°çŠ¶æ€å…ƒç´ ');
                    return;
                }
                statusElement.textContent = message;
                statusElement.className = `status ${type}`;
                debugLog('çŠ¶æ€æ›´æ–°æˆåŠŸ');
            } catch (error) {
                debugLog('æ›´æ–°çŠ¶æ€æ—¶å‡ºé”™:', error);
                console.error('æ›´æ–°çŠ¶æ€æ—¶å‡ºé”™:', error);
            }
        }
    </script>
</body>
</html>